<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmers Management - Almorooj Dairy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #b7ab81 0%, #d4cdb1 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #b7ab81 0%, #d4cdb1 100%);
            color: white;
            padding: 40px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #fff;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header-links a {
            color: white;
            margin-left: 15px;
            text-decoration: none;
            font-size: 14px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .header-links a:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        .content {
            padding: 20px;
        }
        
        .section-title {
            font-size: 22px;
            color: #2d3748;
            margin-bottom: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #b7ab81, #d4cdb1);
            width: 0;
            animation: expandWidth 0.6s ease forwards;
        }
        
        @keyframes expandWidth {
            to { width: 100%; }
        }
        
        /* Summary Cards Section */
        .summary-section {
            margin-bottom: 50px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #b7ab81 0%, #d4cdb1 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.25);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, 20px); }
        }
        
        .summary-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.35);
        }
        
        .summary-card h3 {
            font-size: 14px;
            opacity: 0.95;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        .summary-card .number {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -2px;
            position: relative;
            z-index: 1;
        }
        
        .summary-card .subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }
        
        /* Table Section */
        .table-section {
            margin-bottom: 50px;
        }
        
        .search-filter-bar {
            background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e8e8e8;
        }
        
        .search-filter-bar h3 {
            font-size: 13px;
            color: #333;
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }
        
        .filter-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-tag {
            display: inline-block;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-tag:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .filter-tag.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .table-wrapper {
            overflow-x: hidden;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
            table-layout: fixed;
        }
        
        thead {
            background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 700;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            white-space: normal;
            overflow-wrap: anywhere;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #edf2f7;
            font-size: 12px;
            color: #4a5568;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        /* Keep action buttons from forcing horizontal scroll */
        .col-actions .actions {
            flex-wrap: wrap !important;
            white-space: normal !important;
        }

        /* Break long numeric strings (accounts/swift) to avoid overflow */
        .col-account, .col-swift, .col-phone, .col-nid {
            word-break: break-all;
        }

        /* Center numeric columns for readability */
        .col-code, .col-animals, .col-expected, .col-maximum {
            text-align: center;
        }
        
        tbody tr {
            transition: all 0.2s;
        }
        
        tbody tr:hover {
            background: #f7fafc;
            box-shadow: inset 0 0 0 1px #e2e8f0;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-cow {
            background: #dbeafe;
            color: #0c4a6e;
        }
        
        .badge-camel {
            background: #fed7aa;
            color: #7c2d12;
        }
        
        .code-badge {
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #667eea;
        }
        
        .records-info {
            margin-top: 15px;
            padding: 12px;
            background: #f0f4ff;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 12px;
            color: #4a5568;
        }
        
        .records-info strong {
            color: #667eea;
            font-weight: 700;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
        }

        .header-actions .btn {
            padding: 10px 16px;
            border-radius: 10px;
        }
        
        /* Buttons */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 10px;
        }

        .btn-ghost {
            background: #e5e7eb;
            color: #111827;
            box-shadow: none;
        }

        .btn-ghost:hover {
            background: #d1d5db;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.25);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.25);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.35);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #b7ab81 0%, #d4cdb1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-print {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e8e8e8;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        }
        
        .stat-card label {
            font-size: 11px;
            color: #718096;
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 800;
            color: #2d3748;
            letter-spacing: -1px;
        }
        
        .stat-card .percent {
            font-size: 12px;
            color: #718096;
            margin-top: 8px;
        }
        
        /* Loading & Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            #topNav, .search-filter-bar, .action-bar, .header-actions, .pagination-bar {
                display: none;
            }
        }

        /* Advanced filters */
        .advanced-filters {
            margin-top: 12px;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            display: none;
        }

        .advanced-filters.show {
            display: block;
        }

        .filters-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 13px;
            min-width: 160px;
            background: #fff;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .checkbox {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            font-size: 12px;
            color: #374151;
        }

        .checkbox input {
            width: 16px;
            height: 16px;
        }

        /* Sortable headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable .sort-ind {
            margin-left: 6px;
            color: #94a3b8;
            font-size: 11px;
        }

        /* Column menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-panel {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            width: 260px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 18px 50px rgba(0,0,0,0.18);
            padding: 12px;
            display: none;
            z-index: 1000;
        }

        .dropdown-panel.show {
            display: block;
        }

        .dropdown-panel h4 {
            margin: 0 0 10px;
            font-size: 12px;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .dropdown-panel .checkbox {
            width: 100%;
            justify-content: flex-start;
        }

        /* Hidden columns */
        .col-hidden {
            display: none !important;
        }

        /* Pagination */
        .pagination-bar {
            margin-top: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination .page-pill {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            color: #111827;
        }

        .pagination .page-pill.active {
            border-color: #667eea;
            background: #eef2ff;
            color: #4338ca;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            width: 95%;
            max-width: 900px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.35);
            overflow: hidden;
            animation: modalIn 0.18s ease;
        }

        @keyframes modalIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #b7ab81 0%, #d4cdb1 100%);
            color: #fff;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 0.2px;
        }

        .modal-close {
            background: rgba(255,255,255,0.22);
            border: 1px solid rgba(255,255,255,0.35);
            color: #fff;
            font-size: 18px;
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .modal-body {
            padding: 18px 20px;
            max-height: 75vh;
            overflow-y: auto;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 14px;
        }

        .detail-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
        }

        .detail-label {
            font-size: 11px;
            font-weight: 800;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.35px;
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 13px;
            color: #111827;
            font-weight: 700;
            word-break: break-word;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 14px;
        }

        .form-grid label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 800;
            color: #374151;
        }

        .form-grid input,
        .form-grid select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 13px;
        }

        .form-grid input[readonly] {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .modal-footer {
            padding: 14px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #fff;
        }

        /* Toast */
        #toastContainer {
            position: fixed;
            top: 86px;
            right: 16px;
            z-index: 12000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 280px;
            max-width: 420px;
            background: #111827;
            color: #fff;
            border-radius: 14px;
            padding: 12px 14px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.22);
            font-size: 13px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }

        .toast.success { background: #065f46; }
        .toast.error { background: #991b1b; }
        .toast.info { background: #1f2937; }

        .toast button {
            background: rgba(255,255,255,0.18);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.22);
            border-radius: 10px;
            padding: 4px 8px;
            cursor: pointer;
            font-weight: 800;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div id="topNav" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9999; display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 16px; background: linear-gradient(135deg, #b7ab81 0%, #d4cdb1 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.12);">
        <div style="display: flex; align-items: center; gap: 10px;">
            <a href="/" aria-label="Home" style="display: inline-flex; align-items: center; cursor: pointer;">
                <img src="/logo.png" alt="Logo" style="height: 100px; width: auto; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); background: rgba(57, 50, 50, 0.25); padding: 0;" />
            </a>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button type="button" onclick="history.back()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.35); color: #fff; padding: 8px 12px; border-radius: 10px; font-weight: 700; cursor: pointer;">‚¨Ö Back</button>
                <button type="button" onclick="history.forward()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.35); color: #fff; padding: 8px 12px; border-radius: 10px; font-weight: 700; cursor: pointer;">Forward ‚û°</button>
            </div>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <a href="/" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.35); color: #fff; padding: 8px 12px; border-radius: 10px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center;">üè† Home</a>
        </div>
    </div>
    <div style="height: 130px;"></div>
    <div id="toastContainer"></div>
    <div class="container">
        <div class="header">
            <h1>ü•õ Farmers Management System</h1>
            <div class="header-actions">
                <button class="btn btn-primary btn-small" type="button" onclick="openAddFarmer()">Ôºã Add Farmer</button>
                <div class="dropdown">
                    <button class="btn btn-ghost btn-small" type="button" onclick="toggleColumnsMenu(event)">‚ò∞ Columns</button>
                    <div id="columnsMenu" class="dropdown-panel" onclick="event.stopPropagation()">
                        <h4>Visible Columns</h4>
                        <div id="columnsMenuBody"></div>
                    </div>
                </div>
                <button class="btn btn-ghost btn-small" type="button" onclick="toggleAdvancedFilters()">‚öô Advanced Filters</button>
                <button class="btn btn-ghost btn-small" type="button" onclick="resetAllFilters()">‚Ü∫ Reset</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Summary Statistics -->
            <div class="summary-section">
                <div class="section-title">üìä Overview</div>
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Total Farmers</h3>
                        <div class="number" id="totalFarmers">0</div>
                        <div class="subtitle">All registered farmers</div>
                    </div>
                    <div class="summary-card">
                        <h3>Cow Farmers</h3>
                        <div class="number" id="totalCows">0</div>
                        <div class="subtitle">Dairy cattle</div>
                    </div>
                    <div class="summary-card">
                        <h3>Camel Farmers</h3>
                        <div class="number" id="totalCamels">0</div>
                        <div class="subtitle">Camel dairy</div>
                    </div>
                    <div class="summary-card">
                        <h3>Active Centers</h3>
                        <div class="number" id="totalCenters">0</div>
                        <div class="subtitle">Distribution centers</div>
                    </div>
                </div>
            </div>
            
            <!-- Summary by Center -->
            <div class="table-section">
                <div class="section-title">üìç Summary by Center</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Center Name</th>
                                <th style="text-align: center;">Cow Farmers</th>
                                <th style="text-align: center;">Camel Farmers</th>
                                <th style="text-align: center;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="centerSummaryBody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px; color: #a0aec0;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- All Farmers -->
            <div class="table-section">
                <div class="section-title">üë• Farmers Directory</div>
                
                <div class="search-filter-bar">
                    <h3>üîç Search & Filter</h3>
                    <div class="search-controls">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by code, name, phone, NID, center, area..." />
                        <select id="filterCenter" aria-label="Filter center"></select>
                        <select id="filterArea" aria-label="Filter area"></select>
                        <select id="filterStatus" aria-label="Filter status"></select>
                        <select id="pageSizeSelect" aria-label="Page size">
                            <option value="25">25 / page</option>
                            <option value="50">50 / page</option>
                            <option value="100">100 / page</option>
                            <option value="0">All</option>
                        </select>
                    </div>
                    <div class="filter-tags">
                        <span class="filter-tag" onclick="filterByType('ALL')">All Farmers</span>
                        <span class="filter-tag" onclick="filterByType('COW')">üêÑ Cow Farmers</span>
                        <span class="filter-tag" onclick="filterByType('CAMEL')">üê™ Camel Farmers</span>
                    </div>

                    <div id="advancedFilters" class="advanced-filters">
                        <div class="filters-row" style="margin-bottom: 14px;">
                            <div class="filter-group">
                                <label>Expected Qty (Min)</label>
                                <input id="expectedMin" type="number" placeholder="0" min="0" />
                            </div>
                            <div class="filter-group">
                                <label>Expected Qty (Max)</label>
                                <input id="expectedMax" type="number" placeholder="0" min="0" />
                            </div>
                            <div class="filter-group">
                                <label>Maximum (Min)</label>
                                <input id="maximumMin" type="number" placeholder="0" min="0" />
                            </div>
                            <div class="filter-group">
                                <label>Maximum (Max)</label>
                                <input id="maximumMax" type="number" placeholder="0" min="0" />
                            </div>
                            <div class="filter-group">
                                <label>Animals (Min)</label>
                                <input id="animalsMin" type="number" placeholder="0" min="0" />
                            </div>
                            <div class="filter-group">
                                <label>Animals (Max)</label>
                                <input id="animalsMax" type="number" placeholder="0" min="0" />
                            </div>
                        </div>

                        <div class="filter-group" style="margin-bottom: 10px;">
                            <label>Missing Data</label>
                            <div class="checkbox-group">
                                <label class="checkbox"><input id="missingPhone" type="checkbox" /> Missing Phone</label>
                                <label class="checkbox"><input id="missingNid" type="checkbox" /> Missing NID</label>
                                <label class="checkbox"><input id="missingBankAcc" type="checkbox" /> Missing Bank Account</label>
                                <label class="checkbox"><input id="missingAddress" type="checkbox" /> Missing Address</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-bar">
                    <button class="btn btn-secondary" type="button" onclick="openAddFarmer()">Ôºã Add Farmer</button>
                    <button class="btn btn-export" onclick="exportToCSV()">üì• Export CSV</button>
                    <button class="btn btn-export" onclick="exportToExcel()">üìä Export Excel</button>
                    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
                </div>
                
                <div class="table-wrapper">
                    <table id="farmersTable">
                        <thead>
                            <tr>
                                <th class="sortable col-code" data-key="code">Code <span class="sort-ind" id="sort_code"></span></th>
                                <th class="sortable col-name" data-key="name">Name <span class="sort-ind" id="sort_name"></span></th>
                                <th class="sortable col-type" data-key="type">Type <span class="sort-ind" id="sort_type"></span></th>
                                <th class="sortable col-center" data-key="center">Center <span class="sort-ind" id="sort_center"></span></th>
                                <th class="sortable col-area" data-key="area">Area <span class="sort-ind" id="sort_area"></span></th>
                                <th class="sortable col-phone" data-key="phone">Phone <span class="sort-ind" id="sort_phone"></span></th>
                                <th class="sortable col-nid" data-key="nid">NID <span class="sort-ind" id="sort_nid"></span></th>
                                <th class="sortable col-status" data-key="status">Status <span class="sort-ind" id="sort_status"></span></th>
                                <th class="sortable col-animals" data-key="animal_count">Animals <span class="sort-ind" id="sort_animal_count"></span></th>
                                <th class="col-address">Address</th>
                                <th class="col-bank">Bank</th>
                                <th class="col-account">Account</th>
                                <th class="col-swift">Swift</th>
                                <th class="sortable col-expected" data-key="expected_qty">Expected Qty <span class="sort-ind" id="sort_expected_qty"></span></th>
                                <th class="sortable col-maximum" data-key="maximum">Maximum <span class="sort-ind" id="sort_maximum"></span></th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="farmersList">
                            <tr>
                                <td colspan="16" style="text-align: center; padding: 40px; color: #a0aec0;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="records-info">
                    <strong id="recordCount">0</strong> farmers found
                </div>

                <div class="pagination-bar">
                    <div style="font-size: 12px; color: #6b7280; font-weight: 700;">
                        Showing <span id="showingCount">0</span> of <span id="totalFilteredCount">0</span>
                    </div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="farmerModalOverlay" class="modal-overlay" onclick="onModalOverlayClick(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="farmerModalTitle">Farmer</h3>
                <button class="modal-close" type="button" onclick="closeFarmerModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="farmerView" style="display:none;" class="detail-grid"></div>

                <div id="farmerForm" style="display:none;" class="form-grid">
                    <div>
                        <label>Code *</label>
                        <input id="fm_code" required inputmode="numeric" pattern="[0-9]*" />
                    </div>
                    <div>
                        <label>Name *</label>
                        <input id="fm_name" required />
                    </div>
                    <div>
                        <label>Milk Type *</label>
                        <select id="fm_type" required>
                            <option value="">-- Select --</option>
                            <option value="COW">COW</option>
                            <option value="CAMEL">CAMEL</option>
                        </select>
                    </div>
                    <div>
                        <label>Center *</label>
                        <select id="fm_center" required>
                            <option value="">-- Select Center --</option>
                        </select>
                    </div>
                    <div>
                        <label>Phone *</label>
                        <input id="fm_phone" required inputmode="tel" />
                    </div>
                    <div>
                        <label>NID *</label>
                        <input id="fm_nid" required inputmode="numeric" pattern="[0-9]*" />
                    </div>
                    <div>
                        <label>Area *</label>
                        <input id="fm_area" required />
                    </div>
                    <div>
                        <label>Status *</label>
                        <select id="fm_status" required>
                            <option value="">-- Select --</option>
                            <option value="active">Active</option>
                            <option value="standby">Standby</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div>
                        <label>Animal Count *</label>
                        <input id="fm_animal_count" type="number" min="1" required />
                    </div>
                    <div>
                        <label>Expected Qty *</label>
                        <input id="fm_expected_qty" type="number" min="0" required />
                    </div>
                    <div>
                        <label>Maximum *</label>
                        <input id="fm_maximum" type="number" min="0" required />
                    </div>
                    <div>
                        <label>Bank *</label>
                        <select id="fm_bankSelect" required>
                            <option value="">-- Select Bank --</option>
                            <option value="AUBOOMRUALH" data-name="AHLI BANK S.A.O.G - AHLI ISLAMIC">AHLI BANK S.A.O.G - AHLI ISLAMIC</option>
                            <option value="AUBOOMRU" data-name="AHLI BANK S.A.O.G - RUWI">AHLI BANK S.A.O.G - RUWI</option>
                            <option value="ASMLOMR1" data-name="AL AMIN SECURITIES COMPANY LLC">AL AMIN SECURITIES COMPANY LLC</option>
                            <option value="IZZBOMRU" data-name="ALIZZ ISLAMIC BANK">ALIZZ ISLAMIC BANK</option>
                            <option value="BDOFOMRU" data-name="BANK DHOFAR (S.A.O.G.)">BANK DHOFAR (S.A.O.G.)</option>
                            <option value="BDOFOMRUTFD" data-name="BANK DHOFAR (S.A.O.G.) - TFD">BANK DHOFAR (S.A.O.G.) - TFD</option>
                            <option value="BDOFOMRUMIB" data-name="BANK DHOFAR (S.A.O.G.) - MAISARAH">BANK DHOFAR (S.A.O.G.) - MAISARAH</option>
                            <option value="MELIOMR1" data-name="BANK MELLI IRAN">BANK MELLI IRAN</option>
                            <option value="BMUSOMRX" data-name="BANK MUSCAT SAOG">BANK MUSCAT SAOG</option>
                            <option value="BMUSOMRXISL" data-name="BANK MUSCAT SAOG - ISLAMIC">BANK MUSCAT SAOG - ISLAMIC</option>
                            <option value="BMUSOMRXTBG" data-name="BANK MUSCAT SAOG - TRANSACTION BANKING">BANK MUSCAT SAOG - TRANSACTION BANKING</option>
                            <option value="BNZWOMRX" data-name="BANK NIZWA">BANK NIZWA</option>
                            <option value="BARBOMMXMUT" data-name="BANK OF BARODA - MUTTRAH">BANK OF BARODA - MUTTRAH</option>
                            <option value="BARBOMMXSAL" data-name="BANK OF BARODA - SALALAH">BANK OF BARODA - SALALAH</option>
                            <option value="BARBOMMX" data-name="BANK OF BARODA - RUWI">BANK OF BARODA - RUWI</option>
                            <option value="BARBOMMXSOH" data-name="BANK OF BARODA - SOHAR">BANK OF BARODA - SOHAR</option>
                            <option value="BABEOMRX" data-name="BANK OF BEIRUT">BANK OF BEIRUT</option>
                            <option value="CBOMOMRU" data-name="CENTRAL BANK OF OMAN">CENTRAL BANK OF OMAN</option>
                            <option value="EFGHOMM1" data-name="EFG HERMES OMAN LLC">EFG HERMES OMAN LLC</option>
                            <option value="FIVOOMR1" data-name="FINANCIAL SERVICES COMPANY SAOG">FINANCIAL SERVICES COMPANY SAOG</option>
                            <option value="NBADOMRX" data-name="FIRST ABU DHABI BANK">FIRST ABU DHABI BANK</option>
                            <option value="NBADOMRXCMS" data-name="FIRST ABU DHABI BANK - CMS">FIRST ABU DHABI BANK - CMS</option>
                            <option value="NBADOMRXTFO" data-name="FIRST ABU DHABI BANK - TFO">FIRST ABU DHABI BANK - TFO</option>
                            <option value="GFISOMR1" data-name="GLOBAL FINANCIAL INVESTMENTS HOLDING">GLOBAL FINANCIAL INVESTMENTS HOLDING</option>
                            <option value="GULFOMRX" data-name="GULF INTERNATIONAL BANK">GULF INTERNATIONAL BANK</option>
                            <option value="GISCOMR1" data-name="GULF INVESTMENT SERVICES CO.">GULF INVESTMENT SERVICES CO.</option>
                            <option value="HBZUOMM1" data-name="HABIB BANK LIMITED">HABIB BANK LIMITED</option>
                            <option value="HABBOMRX" data-name="HABIB BANK OMAN">HABIB BANK OMAN</option>
                            <option value="HBMEOMRX" data-name="HSBC BANK MIDDLE EAST">HSBC BANK MIDDLE EAST</option>
                            <option value="MINIOMRU" data-name="MINISTRY OF FINANCE">MINISTRY OF FINANCE</option>
                            <option value="MDSROMR1" data-name="MUSCAT DEPOSITORY">MUSCAT DEPOSITORY</option>
                            <option value="XMUSOMM1" data-name="MUSCAT SECURITIES MARKET">MUSCAT SECURITIES MARKET</option>
                            <option value="MUZNOMR1" data-name="MUZN ISLAMIC BANKING">MUZN ISLAMIC BANKING</option>
                            <option value="NBOMOMRX" data-name="NATIONAL BANK OF OMAN">NATIONAL BANK OF OMAN</option>
                            <option value="NBOMOMRXIBS" data-name="NATIONAL BANK OF OMAN - IBS">NATIONAL BANK OF OMAN - IBS</option>
                            <option value="NBOMOMRXITF" data-name="NATIONAL BANK OF OMAN - ITF">NATIONAL BANK OF OMAN - ITF</option>
                            <option value="NBOMOMRXTSS" data-name="NATIONAL BANK OF OMAN - TSS">NATIONAL BANK OF OMAN - TSS</option>
                            <option value="OPCFOMRX" data-name="OCTAL PETROCHEMICALS FZC">OCTAL PETROCHEMICALS FZC</option>
                            <option value="OMEMOMR1" data-name="OMAN AND EMIRATES INVESTMENT">OMAN AND EMIRATES INVESTMENT</option>
                            <option value="OMABOMRU" data-name="OMAN ARAB BANK">OMAN ARAB BANK</option>
                            <option value="OMABOMRUYSR" data-name="OMAN ARAB BANK - AL-YUSR">OMAN ARAB BANK - AL-YUSR</option>
                            <option value="BOGUOMR1" data-name="OMAN BANKING CORP">OMAN BANKING CORP</option>
                            <option value="OIDIOMR1" data-name="OMAN INTERNATIONAL DEVELOPMENT">OMAN INTERNATIONAL DEVELOPMENT</option>
                            <option value="SGRFOMRA" data-name="OMAN INVESTMENT AUTHORITY">OMAN INVESTMENT AUTHORITY</option>
                            <option value="OIBBOMRX" data-name="OMAN INVESTMENT BANK">OMAN INVESTMENT BANK</option>
                            <option value="OMUEOMR1" data-name="OMAN UNITED EXCHANGE">OMAN UNITED EXCHANGE</option>
                            <option value="QNBAOMRX" data-name="QATAR NATIONAL BANK">QATAR NATIONAL BANK</option>
                            <option value="OTHER" data-name="Other">Other (specify)</option>
                        </select>
                    </div>
                    <div>
                        <label>SWIFT *</label>
                        <input id="fm_bank_swift" placeholder="SWIFT Code" readonly required />
                    </div>
                    <div>
                        <label>Bank Account *</label>
                        <input id="fm_bank_acc" required inputmode="numeric" pattern="[0-9]*" />
                    </div>
                    <div id="fm_bank_other_wrap" style="display:none;">
                        <label>Bank Name (Other) *</label>
                        <input id="fm_bank_other_name" placeholder="Enter bank name" />
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>Address *</label>
                        <input id="fm_address" required />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" type="button" onclick="closeFarmerModal()">Cancel</button>
                <button id="farmerSaveBtn" class="btn btn-primary btn-small" type="button" onclick="saveFarmerModal()">Save</button>
            </div>
        </div>
    </div>
    
    <script>
            let farmers = [];
            let filteredFarmers = [];

            // Filters
            let currentFilterType = 'ALL';
            let searchTerm = '';
            let filterCenter = 'ALL';
            let filterArea = 'ALL';
            let filterStatus = 'ALL';

            let expectedMin = null;
            let expectedMax = null;
            let maximumMin = null;
            let maximumMax = null;
            let animalsMin = null;
            let animalsMax = null;

            let missingPhone = false;
            let missingNid = false;
            let missingBankAcc = false;
            let missingAddress = false;

            // Sorting
            let sortKey = 'code';
            let sortDir = 'asc';

            // Pagination
            let pageSize = 25;
            let currentPage = 1;

            // Modal
            let modalMode = 'view'; // view | add | edit
            let modalCode = null;
            let modalOriginalType = null;

            const columns = [
                { id: 'code', label: 'Code', className: 'col-code' },
                { id: 'name', label: 'Name', className: 'col-name' },
                { id: 'type', label: 'Type', className: 'col-type' },
                { id: 'center', label: 'Center', className: 'col-center' },
                { id: 'area', label: 'Area', className: 'col-area' },
                { id: 'phone', label: 'Phone', className: 'col-phone' },
                { id: 'nid', label: 'NID', className: 'col-nid' },
                { id: 'status', label: 'Status', className: 'col-status' },
                { id: 'animal_count', label: 'Animals', className: 'col-animals' },
                { id: 'address', label: 'Address', className: 'col-address' },
                { id: 'bank', label: 'Bank', className: 'col-bank' },
                { id: 'bank_acc', label: 'Account', className: 'col-account' },
                { id: 'bank_swift', label: 'Swift', className: 'col-swift' },
                { id: 'expected_qty', label: 'Expected Qty', className: 'col-expected' },
                { id: 'maximum', label: 'Maximum', className: 'col-maximum' },
                { id: 'actions', label: 'Actions', className: 'col-actions', locked: true }
            ];

            const visibleColumns = {};
            columns.forEach(c => { visibleColumns[c.id] = true; });

            function escapeHtml(value) {
                const s = String(value ?? '');
                return s
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function toLower(value) {
                return String(value ?? '').toLowerCase();
            }

            function parseNumOrNull(value) {
                if (value === null || value === undefined || value === '') return null;
                const n = Number(value);
                return Number.isFinite(n) ? n : null;
            }

            function showToast(message, type = 'info', timeoutMs = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<div>${escapeHtml(message)}</div>`;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '‚úï';
                btn.onclick = () => toast.remove();
                toast.appendChild(btn);
                container.appendChild(toast);
                setTimeout(() => { toast.remove(); }, timeoutMs);
            }

            async function apiRequest(url, options) {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });

                let json = null;
                try { json = await response.json(); } catch { /* ignore */ }

                if (!response.ok) {
                    const msg = json?.message || json?.error || response.statusText || 'Request failed';
                    throw new Error(msg);
                }

                return json;
            }

            function populateModalCenters(selectedValue) {
                const el = document.getElementById('fm_center');
                if (!el) return;

                const fallback = ['GHADO', 'ZEEK', 'HAJEEF'];
                const found = Array.from(new Set(
                    farmers
                        .map(f => String(f.center || '').trim())
                        .filter(Boolean)
                        .concat(fallback)
                        .concat(selectedValue ? [String(selectedValue).trim()] : [])
                )).sort();

                const current = selectedValue ?? el.value;
                el.innerHTML = '<option value="">-- Select Center --</option>';
                found.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    el.appendChild(opt);
                });
                if (current) el.value = current;
            }

            function setupModalBankSelect() {
                const bankSelect = document.getElementById('fm_bankSelect');
                const swiftInput = document.getElementById('fm_bank_swift');
                const otherWrap = document.getElementById('fm_bank_other_wrap');
                const otherName = document.getElementById('fm_bank_other_name');

                if (!bankSelect || !swiftInput || !otherWrap || !otherName) return;

                const apply = () => {
                    const val = bankSelect.value;
                    if (val === 'OTHER') {
                        otherWrap.style.display = '';
                        otherName.required = true;
                        swiftInput.readOnly = false;
                        if (!swiftInput.value) swiftInput.value = '';
                    } else {
                        otherWrap.style.display = 'none';
                        otherName.required = false;
                        otherName.value = '';
                        swiftInput.readOnly = true;
                        swiftInput.value = val || '';
                    }
                };

                bankSelect.addEventListener('change', apply);
                apply();
            }

            function displaySummary() {
                const totalFarmers = farmers.length;
                const totalCows = farmers.filter(f => f.type === 'COW').length;
                const totalCamels = farmers.filter(f => f.type === 'CAMEL').length;
                const centers = new Set(farmers.map(f => f.center || 'Unknown')).size;

                document.getElementById('totalFarmers').textContent = totalFarmers;
                document.getElementById('totalCows').textContent = totalCows;
                document.getElementById('totalCamels').textContent = totalCamels;
                document.getElementById('totalCenters').textContent = centers;
            }

            function displayCenterSummary() {
                const centerMap = {};
                farmers.forEach(farmer => {
                    const center = farmer.center || 'Unknown';
                    if (!centerMap[center]) centerMap[center] = { cow: 0, camel: 0 };
                    if (farmer.type === 'COW') centerMap[center].cow++;
                    else if (farmer.type === 'CAMEL') centerMap[center].camel++;
                });

                let html = '';
                Object.keys(centerMap).sort().forEach(center => {
                    const counts = centerMap[center];
                    const total = counts.cow + counts.camel;
                    html += `
                        <tr>
                            <td><strong>${escapeHtml(center)}</strong></td>
                            <td style="text-align: center;"><span class="badge badge-cow">${counts.cow}</span></td>
                            <td style="text-align: center;"><span class="badge badge-camel">${counts.camel}</span></td>
                            <td style="text-align: center;"><strong>${total}</strong></td>
                        </tr>
                    `;
                });
                document.getElementById('centerSummaryBody').innerHTML = html || '<tr><td colspan="4" style="text-align: center;">No data</td></tr>';
            }

            function populateSelect(el, placeholder, values) {
                el.innerHTML = '';
                const optAll = document.createElement('option');
                optAll.value = 'ALL';
                optAll.textContent = placeholder;
                el.appendChild(optAll);

                values.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    el.appendChild(opt);
                });
            }

            function initFiltersUI() {
                const centerSelect = document.getElementById('filterCenter');
                const areaSelect = document.getElementById('filterArea');
                const statusSelect = document.getElementById('filterStatus');

                const centers = Array.from(new Set(farmers.map(f => (f.center || '').trim()).filter(Boolean))).sort();
                const areas = Array.from(new Set(farmers.map(f => (f.area || '').trim()).filter(Boolean))).sort();
                const statuses = Array.from(new Set(farmers.map(f => (f.status || '').trim()).filter(Boolean))).sort();

                populateSelect(centerSelect, 'All Centers', centers);
                populateSelect(areaSelect, 'All Areas', areas);
                populateSelect(statusSelect, 'All Status', statuses);

                centerSelect.value = filterCenter;
                areaSelect.value = filterArea;
                statusSelect.value = filterStatus;

                const pageSizeSelect = document.getElementById('pageSizeSelect');
                pageSizeSelect.value = String(pageSize);
            }

            function setFilterTagActive() {
                document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active'));
                const tags = Array.from(document.querySelectorAll('.filter-tag'));
                const idx = currentFilterType === 'ALL' ? 0 : currentFilterType === 'COW' ? 1 : 2;
                if (tags[idx]) tags[idx].classList.add('active');
            }

            function getFilteredFarmers() {
                const term = searchTerm.trim();
                const hasTerm = term.length > 0;

                return farmers.filter(f => {
                    if (currentFilterType !== 'ALL' && f.type !== currentFilterType) return false;

                    if (filterCenter !== 'ALL' && (f.center || '') !== filterCenter) return false;
                    if (filterArea !== 'ALL' && (f.area || '') !== filterArea) return false;
                    if (filterStatus !== 'ALL' && (f.status || '') !== filterStatus) return false;

                    if (missingPhone && String(f.phone || '').trim() !== '') return false;
                    if (missingNid && String(f.nid || '').trim() !== '') return false;
                    if (missingBankAcc && String(f.bank_acc || '').trim() !== '') return false;
                    if (missingAddress && String(f.address || '').trim() !== '') return false;

                    const exp = Number(f.expected_qty || 0);
                    const max = Number(f.maximum || 0);
                    const animals = Number(f.animal_count || 0);

                    if (expectedMin !== null && exp < expectedMin) return false;
                    if (expectedMax !== null && exp > expectedMax) return false;
                    if (maximumMin !== null && max < maximumMin) return false;
                    if (maximumMax !== null && max > maximumMax) return false;
                    if (animalsMin !== null && animals < animalsMin) return false;
                    if (animalsMax !== null && animals > animalsMax) return false;

                    if (!hasTerm) return true;

                    const hay = [
                        f.code,
                        f.name,
                        f.phone,
                        f.nid,
                        f.center,
                        f.area,
                        f.bank,
                        f.bank_acc,
                        f.bank_swift,
                        f.address,
                        f.status
                    ].map(toLower).join(' | ');

                    return hay.includes(term);
                });
            }

            function compareValues(a, b, key) {
                const va = a?.[key];
                const vb = b?.[key];

                const numericKeys = new Set(['expected_qty', 'maximum', 'animal_count']);
                if (numericKeys.has(key)) {
                    const na = Number(va ?? 0);
                    const nb = Number(vb ?? 0);
                    return na - nb;
                }

                return String(va ?? '').localeCompare(String(vb ?? ''), undefined, { numeric: true, sensitivity: 'base' });
            }

            function applyAll() {
                filteredFarmers = getFilteredFarmers();

                filteredFarmers.sort((a, b) => {
                    const cmp = compareValues(a, b, sortKey);
                    return sortDir === 'asc' ? cmp : -cmp;
                });

                const total = filteredFarmers.length;
                document.getElementById('recordCount').textContent = total;
                document.getElementById('totalFilteredCount').textContent = total;

                const totalPages = pageSize === 0 ? 1 : Math.max(1, Math.ceil(total / pageSize));
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                renderSortIndicators();
                renderTable();
                renderPagination();
                setFilterTagActive();
            }

            function getPagedFarmers() {
                if (pageSize === 0) return filteredFarmers;
                const start = (currentPage - 1) * pageSize;
                return filteredFarmers.slice(start, start + pageSize);
            }

            function badgeClass(type) {
                return type === 'COW' ? 'badge-cow' : 'badge-camel';
            }

            function renderTable() {
                const list = getPagedFarmers();
                const total = filteredFarmers.length;

                const showing = list.length;
                document.getElementById('showingCount').textContent = showing;

                let html = '';
                list.forEach(f => {
                    const codeJs = JSON.stringify(String(f.code ?? ''));
                    html += `
                        <tr>
                            <td class="col-code"><span class="code-badge">${escapeHtml(f.code)}</span></td>
                            <td class="col-name"><strong>${escapeHtml(f.name)}</strong></td>
                            <td class="col-type"><span class="badge ${badgeClass(f.type)}">${escapeHtml(f.type || '‚Äî')}</span></td>
                            <td class="col-center">${escapeHtml(f.center || '‚Äî')}</td>
                            <td class="col-area">${escapeHtml(f.area || '‚Äî')}</td>
                            <td class="col-phone">${escapeHtml(f.phone || '‚Äî')}</td>
                            <td class="col-nid">${escapeHtml(f.nid || '‚Äî')}</td>
                            <td class="col-status">${escapeHtml(f.status || '‚Äî')}</td>
                            <td class="col-animals">${escapeHtml(f.animal_count ?? '‚Äî')}</td>
                            <td class="col-address">${escapeHtml(f.address || '‚Äî')}</td>
                            <td class="col-bank">${escapeHtml(f.bank || '‚Äî')}</td>
                            <td class="col-account">${escapeHtml(f.bank_acc || '‚Äî')}</td>
                            <td class="col-swift">${escapeHtml(f.bank_swift || '‚Äî')}</td>
                            <td class="col-expected">${escapeHtml(f.expected_qty ?? '‚Äî')}</td>
                            <td class="col-maximum">${escapeHtml(f.maximum ?? '‚Äî')}</td>
                            <td class="col-actions">
                                <div class="actions" style="display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap;">
                                    <button class="btn btn-ghost btn-small" type="button" onclick='openViewFarmer(${codeJs})'>View</button>
                                    <button class="btn btn-warning btn-small" type="button" onclick='openEditFarmer(${codeJs})'>Edit</button>
                                    <button class="btn btn-danger btn-small" type="button" onclick='deleteFarmer(${codeJs})'>Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                if (total === 0) {
                    html = '<tr><td colspan="16"><div class="empty-state"><div class="empty-state-icon">üîç</div><p>No farmers found</p></div></td></tr>';
                }

                document.getElementById('farmersList').innerHTML = html;
                applyColumnVisibility();
            }

            function renderPagination() {
                const el = document.getElementById('pagination');
                el.innerHTML = '';

                const total = filteredFarmers.length;
                const totalPages = pageSize === 0 ? 1 : Math.max(1, Math.ceil(total / pageSize));
                if (totalPages <= 1) return;

                const mk = (label, page, active = false, disabled = false) => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'page-pill' + (active ? ' active' : '');
                    b.textContent = label;
                    b.disabled = disabled;
                    b.onclick = () => { currentPage = page; applyAll(); };
                    return b;
                };

                el.appendChild(mk('Prev', Math.max(1, currentPage - 1), false, currentPage === 1));

                const windowSize = 5;
                const start = Math.max(1, currentPage - Math.floor(windowSize / 2));
                const end = Math.min(totalPages, start + windowSize - 1);
                const realStart = Math.max(1, end - windowSize + 1);

                if (realStart > 1) {
                    el.appendChild(mk('1', 1, currentPage === 1));
                    if (realStart > 2) {
                        const dots = document.createElement('span');
                        dots.style.color = '#6b7280';
                        dots.style.fontWeight = '800';
                        dots.textContent = '‚Ä¶';
                        el.appendChild(dots);
                    }
                }

                for (let p = realStart; p <= end; p++) {
                    el.appendChild(mk(String(p), p, p === currentPage));
                }

                if (end < totalPages) {
                    if (end < totalPages - 1) {
                        const dots = document.createElement('span');
                        dots.style.color = '#6b7280';
                        dots.style.fontWeight = '800';
                        dots.textContent = '‚Ä¶';
                        el.appendChild(dots);
                    }
                    el.appendChild(mk(String(totalPages), totalPages, currentPage === totalPages));
                }

                el.appendChild(mk('Next', Math.min(totalPages, currentPage + 1), false, currentPage === totalPages));
            }

            function renderSortIndicators() {
                document.querySelectorAll('.sort-ind').forEach(s => (s.textContent = ''));
                const el = document.getElementById(`sort_${sortKey}`);
                if (el) el.textContent = sortDir === 'asc' ? '‚ñ≤' : '‚ñº';
            }

            function setupSortableHeaders() {
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.addEventListener('click', () => {
                        const key = th.getAttribute('data-key');
                        if (!key) return;

                        if (sortKey === key) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                        else {
                            sortKey = key;
                            sortDir = 'asc';
                        }
                        applyAll();
                    });
                });
            }

            function buildColumnsMenu() {
                const body = document.getElementById('columnsMenuBody');
                body.innerHTML = '';

                columns.filter(c => !c.locked).forEach(c => {
                    const label = document.createElement('label');
                    label.className = 'checkbox';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = visibleColumns[c.id] !== false;
                    cb.addEventListener('change', () => {
                        visibleColumns[c.id] = cb.checked;
                        applyColumnVisibility();
                    });

                    const text = document.createElement('span');
                    text.textContent = c.label;

                    label.appendChild(cb);
                    label.appendChild(text);
                    body.appendChild(label);
                });
            }

            function applyColumnVisibility() {
                columns.forEach(c => {
                    const show = c.locked ? true : visibleColumns[c.id] !== false;
                    document.querySelectorAll(`.${c.className}`).forEach(el => {
                        el.classList.toggle('col-hidden', !show);
                    });
                });
            }

            function toggleColumnsMenu(event) {
                event?.stopPropagation?.();
                buildColumnsMenu();
                const menu = document.getElementById('columnsMenu');
                menu.classList.toggle('show');
            }

            function toggleAdvancedFilters() {
                const el = document.getElementById('advancedFilters');
                el.classList.toggle('show');
            }

            function resetAllFilters() {
                currentFilterType = 'ALL';
                searchTerm = '';
                filterCenter = 'ALL';
                filterArea = 'ALL';
                filterStatus = 'ALL';

                expectedMin = null;
                expectedMax = null;
                maximumMin = null;
                maximumMax = null;
                animalsMin = null;
                animalsMax = null;

                missingPhone = false;
                missingNid = false;
                missingBankAcc = false;
                missingAddress = false;

                sortKey = 'code';
                sortDir = 'asc';
                currentPage = 1;

                document.getElementById('searchInput').value = '';
                document.getElementById('filterCenter').value = 'ALL';
                document.getElementById('filterArea').value = 'ALL';
                document.getElementById('filterStatus').value = 'ALL';

                document.getElementById('expectedMin').value = '';
                document.getElementById('expectedMax').value = '';
                document.getElementById('maximumMin').value = '';
                document.getElementById('maximumMax').value = '';
                document.getElementById('animalsMin').value = '';
                document.getElementById('animalsMax').value = '';

                document.getElementById('missingPhone').checked = false;
                document.getElementById('missingNid').checked = false;
                document.getElementById('missingBankAcc').checked = false;
                document.getElementById('missingAddress').checked = false;

                applyAll();
            }

            function filterByType(type) {
                currentFilterType = type;
                currentPage = 1;
                applyAll();
            }

            function setupFilterHandlers() {
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    searchTerm = e.target.value.toLowerCase();
                    currentPage = 1;
                    applyAll();
                });

                document.getElementById('filterCenter').addEventListener('change', (e) => {
                    filterCenter = e.target.value;
                    currentPage = 1;
                    applyAll();
                });

                document.getElementById('filterArea').addEventListener('change', (e) => {
                    filterArea = e.target.value;
                    currentPage = 1;
                    applyAll();
                });

                document.getElementById('filterStatus').addEventListener('change', (e) => {
                    filterStatus = e.target.value;
                    currentPage = 1;
                    applyAll();
                });

                document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
                    pageSize = Number(e.target.value);
                    currentPage = 1;
                    applyAll();
                });

                const bindNum = (id, setter) => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        setter(parseNumOrNull(e.target.value));
                        currentPage = 1;
                        applyAll();
                    });
                };
                bindNum('expectedMin', v => (expectedMin = v));
                bindNum('expectedMax', v => (expectedMax = v));
                bindNum('maximumMin', v => (maximumMin = v));
                bindNum('maximumMax', v => (maximumMax = v));
                bindNum('animalsMin', v => (animalsMin = v));
                bindNum('animalsMax', v => (animalsMax = v));

                const bindChk = (id, setter) => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        setter(e.target.checked);
                        currentPage = 1;
                        applyAll();
                    });
                };
                bindChk('missingPhone', v => (missingPhone = v));
                bindChk('missingNid', v => (missingNid = v));
                bindChk('missingBankAcc', v => (missingBankAcc = v));
                bindChk('missingAddress', v => (missingAddress = v));
            }

            async function loadFarmers() {
                try {
                    const response = await fetch('/api/farmers');
                    farmers = await response.json();
                    displaySummary();
                    displayCenterSummary();
                    initFiltersUI();
                    applyAll();
                } catch (error) {
                    console.error('Error loading farmers:', error);
                    document.getElementById('farmersList').innerHTML =
                        '<tr><td colspan="16" style="text-align: center; color: red; padding: 40px;">Error loading data</td></tr>';
                    showToast(String(error?.message || error), 'error', 5000);
                }
            }

            // Modal helpers
            function onModalOverlayClick(e) {
                if (e.target?.id === 'farmerModalOverlay') closeFarmerModal();
            }

            function closeFarmerModal() {
                document.getElementById('farmerModalOverlay').classList.remove('show');
            }

            function openFarmerModal(mode, farmer) {
                modalMode = mode;
                modalCode = farmer?.code ?? null;
                modalOriginalType = mode === 'edit' ? (farmer?.type ?? null) : null;

                const overlay = document.getElementById('farmerModalOverlay');
                const title = document.getElementById('farmerModalTitle');
                const view = document.getElementById('farmerView');
                const form = document.getElementById('farmerForm');
                const saveBtn = document.getElementById('farmerSaveBtn');

                view.style.display = 'none';
                form.style.display = 'none';

                if (mode === 'view') {
                    title.textContent = `View Farmer: ${farmer?.code || ''}`;
                    saveBtn.style.display = 'none';
                    view.style.display = 'grid';
                    view.innerHTML = buildViewGrid(farmer);
                } else {
                    title.textContent = mode === 'add' ? 'Add Farmer' : `Edit Farmer: ${farmer?.code || ''}`;
                    saveBtn.style.display = 'inline-flex';
                    form.style.display = 'grid';

                    populateModalCenters(farmer?.center);
                    setupModalBankSelect();
                    fillForm(farmer, mode);
                }

                overlay.classList.add('show');
            }

            function buildViewGrid(f) {
                const items = [
                    ['Code', f?.code],
                    ['Name', f?.name],
                    ['Type', f?.type],
                    ['Center', f?.center],
                    ['Area', f?.area],
                    ['Phone', f?.phone],
                    ['NID', f?.nid],
                    ['Status', f?.status],
                    ['Animal Count', f?.animal_count],
                    ['Expected Qty', f?.expected_qty],
                    ['Maximum', f?.maximum],
                    ['Bank', f?.bank],
                    ['Bank Account', f?.bank_acc],
                    ['SWIFT', f?.bank_swift],
                    ['Address', f?.address]
                ];

                return items.map(([k, v]) => `
                    <div class="detail-item">
                        <div class="detail-label">${escapeHtml(k)}</div>
                        <div class="detail-value">${escapeHtml(v ?? '‚Äî')}</div>
                    </div>
                `).join('');
            }

            function fillForm(f, mode) {
                const set = (id, v) => { document.getElementById(id).value = v ?? ''; };

                set('fm_code', f?.code);
                set('fm_name', f?.name);
                set('fm_type', f?.type);
                set('fm_center', f?.center);
                set('fm_phone', f?.phone);
                set('fm_nid', f?.nid);
                set('fm_area', f?.area);
                set('fm_status', f?.status);
                set('fm_animal_count', f?.animal_count ?? '');
                set('fm_expected_qty', f?.expected_qty ?? '');
                set('fm_maximum', f?.maximum ?? '');
                set('fm_bank_acc', f?.bank_acc);
                set('fm_address', f?.address);

                // Bank dropdown + SWIFT auto fill
                const bankSelect = document.getElementById('fm_bankSelect');
                const swiftInput = document.getElementById('fm_bank_swift');
                const otherWrap = document.getElementById('fm_bank_other_wrap');
                const otherName = document.getElementById('fm_bank_other_name');
                const swift = String(f?.bank_swift || '').trim();

                const hasSwiftOption = bankSelect && swift && Array.from(bankSelect.options).some(o => o.value === swift);
                if (bankSelect) {
                    if (hasSwiftOption) {
                        bankSelect.value = swift;
                        if (swiftInput) {
                            swiftInput.readOnly = true;
                            swiftInput.value = swift;
                        }
                        if (otherWrap) otherWrap.style.display = 'none';
                        if (otherName) {
                            otherName.required = false;
                            otherName.value = '';
                        }
                    } else {
                        bankSelect.value = swift || (f?.bank ? 'OTHER' : '');
                        if (bankSelect.value === 'OTHER') {
                            if (swiftInput) {
                                swiftInput.readOnly = false;
                                swiftInput.value = swift;
                            }
                            if (otherWrap) otherWrap.style.display = '';
                            if (otherName) {
                                otherName.required = true;
                                otherName.value = f?.bank || '';
                            }
                        } else {
                            if (swiftInput) {
                                swiftInput.readOnly = true;
                                swiftInput.value = bankSelect.value || '';
                            }
                            if (otherWrap) otherWrap.style.display = 'none';
                            if (otherName) {
                                otherName.required = false;
                                otherName.value = '';
                            }
                        }
                    }
                }

                const codeEl = document.getElementById('fm_code');
                codeEl.readOnly = mode === 'edit';

                const typeEl = document.getElementById('fm_type');
                if (typeEl) typeEl.disabled = mode === 'edit';
            }

            function readForm() {
                const get = (id) => document.getElementById(id).value;

                const bankSelect = document.getElementById('fm_bankSelect');
                const swiftInput = document.getElementById('fm_bank_swift');
                const otherName = document.getElementById('fm_bank_other_name');

                const selectedSwift = bankSelect?.value || '';
                const bankSwift = selectedSwift === 'OTHER' ? (swiftInput?.value || '').trim() : selectedSwift;
                const bankName = selectedSwift === 'OTHER'
                    ? (otherName?.value || '').trim()
                    : (bankSelect?.options?.[bankSelect.selectedIndex]?.getAttribute('data-name') || '').trim();

                const body = {
                    code: get('fm_code')?.trim(),
                    name: get('fm_name')?.trim(),
                    type: get('fm_type')?.trim(),
                    center: get('fm_center')?.trim(),
                    phone: get('fm_phone')?.trim(),
                    nid: get('fm_nid')?.trim(),
                    area: get('fm_area')?.trim(),
                    status: get('fm_status')?.trim(),
                    animal_count: parseNumOrNull(get('fm_animal_count')),
                    expected_qty: parseNumOrNull(get('fm_expected_qty')),
                    maximum: parseNumOrNull(get('fm_maximum')),
                    bank: bankName,
                    bank_acc: get('fm_bank_acc')?.trim(),
                    bank_swift: bankSwift,
                    address: get('fm_address')?.trim()
                };
                return body;
            }

            function validateFarmerBody(body) {
                if (!body.code) return 'Code is required';
                if (!/^\d+$/.test(body.code)) return 'Code must contain only numbers';
                if (!body.name) return 'Name is required';
                if (!body.type) return 'Milk Type is required';
                if (!body.center) return 'Center is required';
                if (!body.phone) return 'Phone is required';
                if (!body.nid) return 'NID is required';
                if (!/^\d+$/.test(body.nid)) return 'NID must contain only numbers';
                if (!body.area) return 'Area is required';
                if (!body.status) return 'Status is required';
                if (body.animal_count === null || body.animal_count < 1) return 'Animal Count must be at least 1';
                if (body.expected_qty === null || body.expected_qty < 0) return 'Expected Qty is required';
                if (body.maximum === null || body.maximum < 0) return 'Maximum is required';
                if (body.maximum < body.expected_qty) return 'Maximum must be >= Expected Qty';
                if (!body.bank) return 'Bank is required';
                if (!body.bank_swift) return 'SWIFT is required';
                if (!body.bank_acc) return 'Bank Account is required';
                if (!/^\d+$/.test(body.bank_acc)) return 'Bank Account must contain only numbers';
                if (!body.address) return 'Address is required';

                if (modalMode === 'edit') {
                    if (body.code !== modalCode) return 'Code cannot be changed during edit';
                    if (modalOriginalType && body.type !== modalOriginalType) return 'Milk Type cannot be changed during edit';
                }
                return null;
            }

            async function saveFarmerModal() {
                try {
                    const body = readForm();
                    const err = validateFarmerBody(body);
                    if (err) {
                        showToast(err, 'error');
                        return;
                    }

                    if (modalMode === 'add') {
                        await apiRequest('/api/farmers', { method: 'POST', body: JSON.stringify(body) });
                        showToast(`Farmer ${body.code} added`, 'success');
                    } else if (modalMode === 'edit') {
                        await apiRequest(`/api/farmers/${encodeURIComponent(modalCode)}`, { method: 'PUT', body: JSON.stringify(body) });
                        showToast(`Farmer ${modalCode} updated`, 'success');
                    }

                    closeFarmerModal();
                    await loadFarmers();
                } catch (e) {
                    showToast(e?.message || 'Save failed', 'error', 5000);
                }
            }

            function openAddFarmer() {
                openFarmerModal('add', {
                    code: '', name: '', type: '', center: '',
                    phone: '', nid: '', area: '', status: 'active',
                    animal_count: '', expected_qty: '', maximum: '',
                    bank: '', bank_acc: '', bank_swift: '', address: ''
                });
            }

            function openViewFarmer(code) {
                const s = String(code ?? '');
                const f = farmers.find(x => String(x.code ?? '') === s);
                if (!f) return;
                openFarmerModal('view', f);
            }

            function openEditFarmer(code) {
                const s = String(code ?? '');
                const f = farmers.find(x => String(x.code ?? '') === s);
                if (!f) return;
                openFarmerModal('edit', f);
            }

            async function deleteFarmer(code) {
                const s = String(code ?? '');
                const ok = confirm(`Are you sure you want to delete farmer ${s}?`);
                if (!ok) return;

                try {
                    await apiRequest(`/api/farmers/${encodeURIComponent(s)}`, { method: 'DELETE' });
                    showToast(`Farmer ${s} deleted`, 'success');
                    await loadFarmers();
                } catch (e) {
                    showToast(e?.message || 'Delete failed', 'error', 5000);
                }
            }

            function getSelectedExportColumns() {
                // Export should follow the ‚ò∞ Columns selection (exclude Actions)
                return columns.filter(c => c.id !== 'actions' && (c.locked ? true : visibleColumns[c.id] !== false));
            }

            function getExportCellValue(f, colId) {
                switch (colId) {
                    case 'code': return f.code ?? '';
                    case 'name': return f.name ?? '';
                    case 'type': return f.type ?? '';
                    case 'center': return f.center ?? '';
                    case 'area': return f.area ?? '';
                    case 'phone': return f.phone ?? '';
                    case 'nid': return f.nid ?? '';
                    case 'status': return f.status ?? '';
                    case 'animal_count': {
                        const v = f.animal_count;
                        if (typeof v === 'number') return v;
                        if (v === null || v === undefined || v === '') return '';
                        const n = Number(v);
                        return Number.isFinite(n) ? n : '';
                    }
                    case 'expected_qty': {
                        const v = f.expected_qty;
                        if (typeof v === 'number') return v;
                        if (v === null || v === undefined || v === '') return '';
                        const n = Number(v);
                        return Number.isFinite(n) ? n : '';
                    }
                    case 'maximum': {
                        const v = f.maximum;
                        if (typeof v === 'number') return v;
                        if (v === null || v === undefined || v === '') return '';
                        const n = Number(v);
                        return Number.isFinite(n) ? n : '';
                    }
                    case 'bank': return f.bank ?? '';
                    case 'bank_acc': return f.bank_acc ?? '';
                    case 'bank_swift': return f.bank_swift ?? '';
                    case 'address': return f.address ?? '';
                    default: return f?.[colId] ?? '';
                }
            }

            function exportToCSV() {
                const selected = getSelectedExportColumns();
                if (!selected.length) {
                    showToast('No columns selected for export', 'error', 4000);
                    return;
                }

                const headers = selected.map(c => c.label);
                const rows = filteredFarmers.map(f => selected.map(c => getExportCellValue(f, c.id)));

                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${String(cell ?? '').replace(/"/g, '""')}"`).join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `farmers_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }

            function loadScriptOnce(src) {
                return new Promise((resolve, reject) => {
                    const existing = document.querySelector(`script[data-src="${src}"]`);
                    if (existing) {
                        if (existing.getAttribute('data-loaded') === '1') return resolve();
                        existing.addEventListener('load', () => resolve());
                        existing.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)));
                        return;
                    }

                    const s = document.createElement('script');
                    s.src = src;
                    s.async = true;
                    s.defer = true;
                    s.setAttribute('data-src', src);
                    s.addEventListener('load', () => {
                        s.setAttribute('data-loaded', '1');
                        resolve();
                    });
                    s.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)));
                    document.head.appendChild(s);
                });
            }

            async function ensureXlsxLoaded() {
                if (window.XLSX) return;

                // Prefer xlsx-js-style (supports cell styling). Fall back to regular SheetJS.
                const primary = 'https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js';
                const fallback = 'https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js';
                const plainFallback = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';

                try {
                    await loadScriptOnce(primary);
                } catch {
                    try {
                        await loadScriptOnce(fallback);
                    } catch {
                        await loadScriptOnce(plainFallback);
                    }
                }

                if (!window.XLSX) {
                    throw new Error('Excel export library failed to load');
                }
            }

            function excelColName(colIndexZeroBased) {
                let n = colIndexZeroBased + 1;
                let name = '';
                while (n > 0) {
                    const rem = (n - 1) % 26;
                    name = String.fromCharCode(65 + rem) + name;
                    n = Math.floor((n - 1) / 26);
                }
                return name;
            }

            function applyCellStyle(ws, addr, style) {
                const cell = ws[addr];
                if (!cell) return;
                cell.s = { ...(cell.s || {}), ...(style || {}) };
            }

            async function exportToExcel() {
                try {
                    await ensureXlsxLoaded();

                    const selected = getSelectedExportColumns();
                    if (!selected.length) {
                        showToast('No columns selected for export', 'error', 4000);
                        return;
                    }

                    const headers = selected.map(c => c.label);
                    const rows = filteredFarmers.map(f => selected.map(c => getExportCellValue(f, c.id)));

                    const now = new Date();
                    const isoDate = now.toISOString().split('T')[0];
                    const time = now.toTimeString().slice(0, 5).replace(':', '-');
                    const title = 'Farmers Export';
                    const subtitle = `Generated: ${now.toLocaleString()} | Records: ${rows.length}`;

                    // Build AOA: title row + subtitle row + headers + data rows
                    const aoa = [];
                    aoa.push([title]);
                    aoa.push([subtitle]);
                    aoa.push(headers);
                    rows.forEach(r => aoa.push(r));

                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    const colCount = headers.length;
                    const lastCol = excelColName(colCount - 1);
                    const lastRow = aoa.length;

                    // Merge title + subtitle across all columns
                    ws['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } },
                        { s: { r: 1, c: 0 }, e: { r: 1, c: colCount - 1 } }
                    ];

                    // Column widths (dynamic based on selected columns)
                    const widthById = {
                        code: 10,
                        name: 28,
                        type: 10,
                        center: 18,
                        area: 18,
                        phone: 16,
                        nid: 16,
                        status: 12,
                        animal_count: 10,
                        expected_qty: 14,
                        maximum: 14,
                        bank: 28,
                        bank_acc: 18,
                        bank_swift: 14,
                        address: 40
                    };
                    ws['!cols'] = selected.map(c => ({ wch: widthById[c.id] ?? 16 }));

                    // Row heights for better readability
                    ws['!rows'] = [
                        { hpt: 26 },
                        { hpt: 18 },
                        { hpt: 20 }
                    ];

                    // Auto filter (headers are on row 3 => 1-based)
                    ws['!autofilter'] = { ref: `A3:${lastCol}${lastRow}` };

                    // Try to freeze top 3 rows (title + subtitle + header)
                    ws['!sheetViews'] = [{
                        pane: {
                            ySplit: 3,
                            topLeftCell: 'A4',
                            activePane: 'bottomLeft',
                            state: 'frozen'
                        }
                    }];

                    // Styles (works when xlsx-js-style is loaded)
                    const borderAll = {
                        top: { style: 'thin', color: { rgb: 'D1D5DB' } },
                        bottom: { style: 'thin', color: { rgb: 'D1D5DB' } },
                        left: { style: 'thin', color: { rgb: 'D1D5DB' } },
                        right: { style: 'thin', color: { rgb: 'D1D5DB' } }
                    };

                    const titleStyle = {
                        font: { bold: true, sz: 16, color: { rgb: 'FFFFFF' } },
                        fill: { patternType: 'solid', fgColor: { rgb: '8E8E66' } },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };
                    const subtitleStyle = {
                        font: { italic: true, sz: 10, color: { rgb: '374151' } },
                        fill: { patternType: 'solid', fgColor: { rgb: 'F3F4F6' } },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };
                    const headerStyle = {
                        font: { bold: true, color: { rgb: 'FFFFFF' } },
                        fill: { patternType: 'solid', fgColor: { rgb: 'B7AB81' } },
                        alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                        border: borderAll
                    };
                    const textCellStyle = {
                        font: { color: { rgb: '111827' } },
                        alignment: { vertical: 'top', wrapText: true },
                        border: borderAll
                    };
                    const numberCellStyle = {
                        ...textCellStyle,
                        alignment: { horizontal: 'center', vertical: 'top' }
                    };
                    const altFill = { patternType: 'solid', fgColor: { rgb: 'F8FAFC' } };

                    // Apply title/subtitle styles
                    applyCellStyle(ws, 'A1', titleStyle);
                    applyCellStyle(ws, 'A2', subtitleStyle);

                    // Apply header styles
                    for (let c = 0; c < colCount; c++) {
                        const addr = `${excelColName(c)}3`;
                        applyCellStyle(ws, addr, headerStyle);
                    }

                    // Apply data styles + alternating row fill
                    const numericIds = new Set(['animal_count', 'expected_qty', 'maximum']);
                    for (let r = 4; r <= lastRow; r++) {
                        const isAlt = (r % 2 === 0);
                        for (let c = 0; c < colCount; c++) {
                            const addr = `${excelColName(c)}${r}`;
                            const isNumericCol = numericIds.has(selected[c]?.id);
                            const base = isNumericCol ? numberCellStyle : textCellStyle;
                            const style = isAlt ? { ...base, fill: altFill } : base;
                            applyCellStyle(ws, addr, style);
                        }
                    }

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Farmers');

                    const filename = `farmers_${isoDate}_${time}.xlsx`;
                    XLSX.writeFile(wb, filename);
                } catch (e) {
                    showToast(e?.message || 'Excel export failed', 'error', 5000);
                }
            }

            // Global click: close columns menu
            document.addEventListener('click', () => {
                const menu = document.getElementById('columnsMenu');
                if (menu) menu.classList.remove('show');
            });

            window.addEventListener('load', () => {
                setupSortableHeaders();
                setupFilterHandlers();
                renderSortIndicators();
                buildColumnsMenu();
                applyColumnVisibility();

                const menu = document.getElementById('columnsMenu');
                if (menu) menu.addEventListener('click', (e) => e.stopPropagation());

                loadFarmers();
            });
    </script>
</body>
</html>
